# 📊 Анализ интеграции проектов в VendHub OS

## 🎯 Ключевое условие

> **Нет прямого подключения к вендинговым автоматам!**
> Данные о продажах загружаются из файлов отчётности (Excel, CSV).
> Из загруженных данных формируется база данных → из БД формируются отчёты.

---

## 📁 Проанализированные проекты

| Проект | Назначение | Статус | Ценность для VendHub OS |
|--------|------------|--------|-------------------------|
| **VendCash** | Учёт инкассации наличных | Production-ready | ⭐⭐⭐⭐⭐ Критически важен |
| **VendtripBot** | GPS-трекинг поездок, верификация задач | Production-ready | ⭐⭐⭐⭐ Высокая |
| **Master Data** | Справочники и классификаторы | Спецификация | ⭐⭐⭐⭐⭐ Критически важен |
| **VHR (тестовые CSV)** | Примеры файлов импорта | Данные | ⭐⭐⭐ Полезно |

---

## 🔄 Архитектура потока данных (без прямого подключения к автоматам)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        ВНЕШНИЕ ИСТОЧНИКИ ДАННЫХ                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │  Payme       │  │  Click       │  │  Uzum        │  │  HUMO/UZCARD │ │
│  │  Отчёты      │  │  Отчёты      │  │  Отчёты      │  │  Отчёты      │ │
│  │  (Excel/CSV) │  │  (Excel/CSV) │  │  (Excel/CSV) │  │  (Excel/CSV) │ │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘ │
│         │                 │                 │                 │          │
│         └─────────────────┴────────┬────────┴─────────────────┘          │
│                                    │                                      │
│  ┌──────────────┐  ┌──────────────┐│  ┌──────────────┐  ┌──────────────┐ │
│  │  Терминалы   │  │  1C/ERP      ││  │  Инкассация  │  │  GPS-треки   │ │
│  │  (XML/CSV)   │  │  Выгрузки    ││  │  (VendCash)  │  │  (VendTrip)  │ │
│  └──────┬───────┘  └──────┬───────┘│  └──────┬───────┘  └──────┬───────┘ │
│         │                 │        │         │                 │          │
│         └─────────────────┴────────┴─────────┴─────────────────┘          │
│                                    │                                      │
└────────────────────────────────────┼──────────────────────────────────────┘
                                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                     VENDHUB OS - СЛОЙ ИМПОРТА ДАННЫХ                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │                    INTELLIGENT IMPORT ENGINE                         ││
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐    ││
│  │  │  Загрузка  │→ │  Авто-     │→ │  Маппинг   │→ │ Валидация  │    ││
│  │  │  файла     │  │ Классиф.   │  │  колонок   │  │  данных    │    ││
│  │  └────────────┘  └────────────┘  └────────────┘  └────────────┘    ││
│  │                                                        ↓             ││
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐    ││
│  │  │  Аудит     │← │ Выполнение │← │ Одобрение  │← │ Сверка с   │    ││
│  │  │  лог       │  │  импорта   │  │ (Approval) │  │  базой     │    ││
│  │  └────────────┘  └────────────┘  └────────────┘  └────────────┘    ││
│  └─────────────────────────────────────────────────────────────────────┘│
│                                    ↓                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │                     ЦЕНТРАЛЬНАЯ БАЗА ДАННЫХ                          ││
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐    ││
│  │  │ Транзакции │  │ Продукты   │  │ Автоматы   │  │ Инкассации │    ││
│  │  │ (Sales)    │  │ (Products) │  │ (Machines) │  │ (Collect)  │    ││
│  │  └────────────┘  └────────────┘  └────────────┘  └────────────┘    ││
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐    ││
│  │  │ Инвентарь  │  │ Справочники│  │ Маршруты   │  │ Сверки     │    ││
│  │  │ (Inventory)│  │ (MDM)      │  │ (Trips)    │  │ (Reconc)   │    ││
│  │  └────────────┘  └────────────┘  └────────────┘  └────────────┘    ││
│  └─────────────────────────────────────────────────────────────────────┘│
│                                    ↓                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │                     АНАЛИТИКА И ОТЧЁТЫ                               ││
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐    ││
│  │  │ Дашборды   │  │ Отчёты     │  │ Сверки     │  │ Экспорт    │    ││
│  │  │ KPI        │  │ (Custom)   │  │ баланса    │  │ Excel/PDF  │    ││
│  │  └────────────┘  └────────────┘  └────────────┘  └────────────┘    ││
│  └─────────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────────┘
```

---

## ✅ Что уже реализовано в VendHub OS

### Модуль импорта (уже есть!)

| Функционал | Статус | Описание |
|------------|--------|----------|
| Загрузка CSV/Excel/JSON | ✅ Есть | До 50MB, авто-определение типа |
| Авто-классификация | ✅ Есть | По содержимому определяет тип данных |
| Маппинг колонок | ✅ Есть | Ручной и автоматический |
| Валидация данных | ✅ Есть | Правила по доменам |
| Workflow одобрения | ✅ Есть | PENDING → APPROVED → EXECUTED |
| Аудит-лог | ✅ Есть | Полное логирование изменений |
| Шаблоны импорта | ✅ Есть | Переиспользуемые конфигурации |
| Экспорт Excel | ✅ Есть | Многостраничные отчёты |

### Типы импорта (поддерживаются)

```
PRODUCTS, MACHINES, USERS, EMPLOYEES, TRANSACTIONS,
SALES, INVENTORY, CUSTOMERS, PRICES, CATEGORIES,
LOCATIONS, CONTRACTORS, RECIPES, PLANOGRAMS, CONTRACTS
```

---

## 🔴 Что НЕ хватает и нужно взять из других проектов

### 1. Из VendCash — Учёт инкассации

**Критически важно для вашего бизнеса!**

| Компонент | Что взять | Приоритет |
|-----------|-----------|-----------|
| **Collection Entity** | Учёт инкассаций с workflow (collected → received → cancelled) | 🔴 Critical |
| **BankDeposit Entity** | Учёт банковских депозитов | 🔴 Critical |
| **Баланс наличных** | `total_received - total_deposited = cash_on_hand` | 🔴 Critical |
| **Дубликат-детекция** | 30-минутное окно для предотвращения дублей | 🟡 Important |
| **Telegram бот** | Операторы фиксируют сбор через бот | 🟢 Nice-to-have |
| **Отчёты по инкассации** | По автоматам, по операторам, по датам | 🟡 Important |

**Предлагаемая схема:**

```sql
-- Таблица инкассаций
CREATE TABLE collections (
    id UUID PRIMARY KEY,
    organization_id UUID,
    machine_id UUID REFERENCES machines(id),
    operator_id UUID REFERENCES users(id),
    manager_id UUID REFERENCES users(id),
    amount DECIMAL(15,2) NOT NULL,
    status VARCHAR(20) DEFAULT 'collected',  -- collected, received, cancelled
    source VARCHAR(20) DEFAULT 'manual',     -- realtime, manual_history, excel_import
    collected_at TIMESTAMP WITH TIME ZONE,
    received_at TIMESTAMP WITH TIME ZONE,
    latitude DECIMAL(10,8),
    longitude DECIMAL(11,8),
    notes TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    deleted_at TIMESTAMP WITH TIME ZONE
);

-- Таблица банковских депозитов
CREATE TABLE bank_deposits (
    id UUID PRIMARY KEY,
    organization_id UUID,
    amount DECIMAL(15,2) NOT NULL,
    deposit_date DATE NOT NULL,
    deposited_by_id UUID REFERENCES users(id),
    notes TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

---

### 2. Из Master Data — Система справочников

**Очень важно для унификации данных!**

| Компонент | Что взять | Приоритет |
|-----------|-----------|-----------|
| **Directories + Items** | Структурированные справочники | 🔴 Critical |
| **OFFICIAL/LOCAL Origin** | Разделение официальных и пользовательских данных | 🟡 Important |
| **Авто-синхронизация** | Cron для внешних источников (ИКПУ и др.) | 🟢 Nice-to-have |
| **Иерархия** | Поддержка parent-child связей | 🟡 Important |
| **Версионирование** | История изменений справочников | 🟢 Nice-to-have |

**Уже запланировано в FINAL_IMPLEMENTATION_PROMPT.md!**

---

### 3. Из VendtripBot — Сверка задач и маршрутов

**Важно для контроля выполнения!**

| Компонент | Что взять | Приоритет |
|-----------|-----------|-----------|
| **Trip ↔ Task Linking** | Связь поездок с задачами | 🟡 Important |
| **GPS-верификация** | Подтверждение посещения точки | 🟡 Important |
| **Reconciliation Mismatches** | 18+ типов расхождений | 🟢 Nice-to-have |
| **Аномалии GPS** | Детекция подозрительных паттернов | 🟢 Nice-to-have |

**Уже есть частично:**
- `reconciliation_mismatches` - создана
- `route_stops` - создана

---

### 4. Специфичные форматы импорта платёжных систем

**Из VHR (тестовые данные) видны форматы:**

```
Файлы отчётности:
├── test_payme.csv     → Формат Payme
├── test_click.csv     → Формат Click
├── test_uzum.csv      → Формат Uzum
└── test_hw_orders.csv → Формат Hardware Orders
```

**Нужно добавить:**

```typescript
// Специфичные парсеры для платёжных систем
interface PaymentReportParser {
  payme: PaymeReportParser;    // Специфичный формат Payme
  click: ClickReportParser;     // Специфичный формат Click
  uzum: UzumReportParser;       // Специфичный формат Uzum
  humo: HumoReportParser;       // Формат HUMO
  uzcard: UzcardReportParser;   // Формат UZCARD
}
```

---

## 📊 Матрица интеграции

```
                    ┌─────────────────────────────────────────────────────┐
                    │               VENDHUB OS                             │
                    │                                                      │
  ┌─────────────────┼──────────────────────────────────────────────────────┤
  │                 │  Import    │  Master   │  Finance  │  Tasks/   │     │
  │  ПРОЕКТ         │  Module    │  Data     │  Module   │  Routes   │     │
  ├─────────────────┼────────────┼───────────┼───────────┼───────────┼─────┤
  │  VendCash       │  Excel     │     -     │ ★★★★★    │     -     │     │
  │                 │  import    │           │ Collections│          │     │
  │                 │  шаблоны   │           │ Deposits   │          │     │
  ├─────────────────┼────────────┼───────────┼───────────┼───────────┼─────┤
  │  VendtripBot    │     -      │ Locations │    -      │ ★★★★★    │     │
  │                 │            │ sync      │           │ Trip-Task │     │
  │                 │            │           │           │ Reconcil. │     │
  ├─────────────────┼────────────┼───────────┼───────────┼───────────┼─────┤
  │  Master Data    │  Schema    │ ★★★★★    │     -     │     -     │     │
  │                 │  definitions│ Full spec │           │           │     │
  │                 │            │ 15 tables │           │           │     │
  ├─────────────────┼────────────┼───────────┼───────────┼───────────┼─────┤
  │  VHR (CSV)      │ ★★★★★     │     -     │  Payment  │     -     │     │
  │                 │  Форматы   │           │  parsers  │           │     │
  │                 │  файлов    │           │           │           │     │
  └─────────────────┴────────────┴───────────┴───────────┴───────────┴─────┘
```

---

## 🏗️ Рекомендуемая архитектура импорта данных

### Поток: Файл отчёта → База данных → Отчёты

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         ЭТАП 1: ЗАГРУЗКА                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   [Пользователь]                                                         │
│        │                                                                 │
│        ▼                                                                 │
│   ┌─────────────────┐                                                    │
│   │  Выбор файла    │  Excel / CSV / XML                                 │
│   │  + Тип отчёта   │  Payme / Click / Uzum / Терминал / Инкассация     │
│   └────────┬────────┘                                                    │
│            │                                                             │
│            ▼                                                             │
│   ┌─────────────────┐    ┌─────────────────┐                            │
│   │  Авто-детекция  │───▶│  Предпросмотр   │                            │
│   │  формата        │    │  5 строк        │                            │
│   └─────────────────┘    └─────────────────┘                            │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         ЭТАП 2: ОБРАБОТКА                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐    │
│   │  Маппинг        │───▶│  Валидация      │───▶│  Сверка с БД    │    │
│   │  колонок        │    │  данных         │    │  (дубликаты)    │    │
│   └─────────────────┘    └─────────────────┘    └─────────────────┘    │
│                                                                          │
│   Специфичные парсеры:                                                   │
│   ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐     │
│   │  Payme   │ │  Click   │ │  Uzum    │ │  HUMO    │ │ Terminal │     │
│   │  Parser  │ │  Parser  │ │  Parser  │ │  Parser  │ │  Parser  │     │
│   └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘     │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         ЭТАП 3: ПОДТВЕРЖДЕНИЕ                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │  PREVIEW SCREEN                                                  │   │
│   │  ┌─────────────────────────────────────────────────────────────┐│   │
│   │  │ Файл: payme_report_2026-02.xlsx                             ││   │
│   │  │ Тип: Платежи Payme                                          ││   │
│   │  │ Строк: 1,247                                                ││   │
│   │  │ Период: 01.02.2026 - 28.02.2026                             ││   │
│   │  │                                                              ││   │
│   │  │ ✅ Новых транзакций: 1,180                                  ││   │
│   │  │ ⚠️  Возможных дубликатов: 67                                 ││   │
│   │  │ ❌ Ошибок валидации: 0                                       ││   │
│   │  │                                                              ││   │
│   │  │ Сумма к импорту: 45,234,500 UZS                             ││   │
│   │  │                                                              ││   │
│   │  │  [Просмотреть дубликаты]  [Импортировать]  [Отмена]         ││   │
│   │  └─────────────────────────────────────────────────────────────┘│   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         ЭТАП 4: СОХРАНЕНИЕ                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐    │
│   │  Транзакции     │    │  Import Log     │    │  Reconciliation │    │
│   │  (sales)        │    │  (история)      │    │  (расхождения)  │    │
│   └─────────────────┘    └─────────────────┘    └─────────────────┘    │
│                                                                          │
│   ┌─────────────────┐    ┌─────────────────┐                            │
│   │  Daily Stats    │    │  Analytics      │                            │
│   │  (агрегация)    │    │  Snapshots      │                            │
│   └─────────────────┘    └─────────────────┘                            │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         ЭТАП 5: ОТЧЁТНОСТЬ                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌────────────┐ │
│   │  Дашборд     │  │  Отчёт по    │  │  Сверка      │  │  Экспорт   │ │
│   │  продаж      │  │  автоматам   │  │  инкассации  │  │  Excel     │ │
│   └──────────────┘  └──────────────┘  └──────────────┘  └────────────┘ │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 📋 План интеграции (пошаговый)

### Фаза 1: Финансовый модуль (из VendCash) — 2-3 дня

```
Задачи:
├── 1.1 Создать entity: Collection (инкассация)
├── 1.2 Создать entity: BankDeposit (депозиты)
├── 1.3 Создать service: CollectionsService
├── 1.4 Создать controller: CollectionsController
├── 1.5 Добавить импорт инкассаций из Excel
├── 1.6 Создать отчёт: Баланс наличных
└── 1.7 Создать отчёт: Сверка инкассация vs продажи
```

### Фаза 2: Парсеры платёжных систем — 2-3 дня

```
Задачи:
├── 2.1 Изучить форматы файлов (Payme, Click, Uzum)
├── 2.2 Создать PaymeReportParser
├── 2.3 Создать ClickReportParser
├── 2.4 Создать UzumReportParser
├── 2.5 Интегрировать в Intelligent Import
└── 2.6 Добавить авто-детекцию формата
```

### Фаза 3: Справочники (из Master Data) — 3-4 дня

```
Задачи:
├── 3.1 Реализовать dictionaries (уже в промте!)
├── 3.2 Добавить системные справочники (seed)
├── 3.3 Создать UI для управления справочниками
├── 3.4 Интегрировать в формы (Select с инлайн-создания)
└── 3.5 Добавить импорт справочников
```

### Фаза 4: Сверка и верификация (из VendtripBot) — 2-3 дня

```
Задачи:
├── 4.1 Расширить reconciliation_mismatches
├── 4.2 Добавить сверку: Продажи vs Инкассации
├── 4.3 Добавить сверку: Остатки vs Загрузки
├── 4.4 Создать дашборд расхождений
└── 4.5 Добавить алерты при критических расхождениях
```

---

## 🎯 Что взять из каждого проекта

### VendCash → VendHub OS

| Компонент | Файл-источник | Куда интегрировать |
|-----------|---------------|-------------------|
| Collection Entity | `backend/src/collections/collection.entity.ts` | `modules/collections/` |
| BankDeposit Entity | `backend/src/finance/bank-deposit.entity.ts` | `modules/finance/` |
| Collections Service | `backend/src/collections/collections.service.ts` | Логика сбора |
| Дубликат-детекция | `collections.service.ts` (30-min window) | Import validation |
| Отчёты Finance | `backend/src/reports/` | Reports module |
| Excel Import | `frontend/src/pages/ExcelImport/` | UI компонент |

### VendtripBot → VendHub OS

| Компонент | Что взять | Куда интегрировать |
|-----------|-----------|-------------------|
| Trip-Task Link | `trip-task-links.entity.ts` | Tasks module |
| Reconciliation types | 18 типов расхождений | `reconciliation_mismatches` |
| GPS validation | Haversine distance calc | Route verification |

### Master Data → VendHub OS

| Компонент | Что взять | Куда интегрировать |
|-----------|-----------|-------------------|
| Full spec | SQL migration + NestJS examples | Dictionaries module |
| JSONB patterns | Flexible schema storage | Entity metadata |
| Sync scheduler | Cron-based external sync | Background jobs |

---

## 📊 Итоговая оценка

### Текущий статус VendHub OS

```
Общая готовность:          85/100

├── Импорт данных:          90%  ✅ Есть Intelligent Import
├── Справочники:            20%  ⚠️  Нужны dictionaries
├── Финансы/Инкассация:     10%  ❌ Нужен модуль из VendCash
├── Сверка/Reconciliation:  60%  ⚠️  Частично есть
├── Парсеры платежей:        0%  ❌ Нужны специфичные парсеры
└── Отчётность:             80%  ✅ Custom Reports запланирован
```

### После интеграции

```
Ожидаемая готовность:      95/100

├── Импорт данных:          95%  ✅ + Парсеры платежей
├── Справочники:            90%  ✅ + Master Data
├── Финансы/Инкассация:     85%  ✅ + VendCash модуль
├── Сверка/Reconciliation:  90%  ✅ + Расширенные проверки
├── Парсеры платежей:       80%  ✅ + Payme/Click/Uzum
└── Отчётность:             90%  ✅ + Custom Reports
```

---

## ✅ Резюме рекомендаций

1. **Приоритет #1**: Интегрировать финансовый модуль из **VendCash** (инкассации, депозиты, баланс)

2. **Приоритет #2**: Реализовать **dictionaries** из FINAL_IMPLEMENTATION_PROMPT.md (уже готовый код!)

3. **Приоритет #3**: Создать специфичные **парсеры** для Payme, Click, Uzum на базе тестовых CSV из VHR

4. **Приоритет #4**: Расширить **reconciliation_mismatches** типами из VendtripBot

5. **Архитектура данных**: Всё строится на модели "Файл → Импорт → БД → Отчёты" без прямого подключения к автоматам

---

*Отчёт сгенерирован на основе анализа проектов VendCash, VendtripBot, Master Data, VHR*
*Дата: 4 февраля 2026*
